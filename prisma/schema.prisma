generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum BucketMode {
  PRESET
  CUSTOM
}

enum PresetBucketKey {
  NEEDS
  WANTS
  SAVINGS
}

enum TransactionSource {
  EMAIL
  MANUAL
  SCHEDULED
}

enum ScheduledRecurrence {
  MONTHLY
}

enum NetWorthCategory {
  ASSET
  DEBT
  LIQUIDITY
}

model User {
  id              String                @id @default(cuid())
  supabaseUserId  String?               @unique
  email           String?
  bucketMode      BucketMode            @default(PRESET)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  buckets         UserBucket[]
  transactions    Transaction[]
  scheduled       ScheduledTransaction[]
  drafts          TransactionDraft[]
  categories      Category[]
  budgets         Budget[]
  rules           Rule[]
  incomes         Income[]
  gmailCredential GmailCredential?
  netWorthSnapshots NetWorthSnapshot[]

  @@index([supabaseUserId])
}

model UserBucket {
  id          String             @id @default(cuid())
  user        User               @relation(fields: [userId], references: [id])
  userId      String
  name        String
  sortOrder   Int                @default(0)
  color       String?
  mode        BucketMode
  presetKey   PresetBucketKey?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  categories  Category[]
  transactions Transaction[]
  scheduled   ScheduledTransaction[]
  drafts      TransactionDraft[]
  rules       Rule[]
  budgetRows  BudgetBucket[]

  @@index([userId])
  @@unique([userId, presetKey])
}

model Transaction {
  id             String      @id @default(cuid())
  user           User        @relation(fields: [userId], references: [id])
  userId         String
  userBucket     UserBucket  @relation(fields: [userBucketId], references: [id])
  userBucketId   String
  date           DateTime
  amount         Decimal
  currency       String
  merchant       String?
  category       Category?   @relation(fields: [categoryId], references: [id])
  categoryId     String?
  source         TransactionSource
  emailMessageId String?
  rawPayload     Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([userId])
  @@index([userBucketId])
  @@unique([userId, emailMessageId])
}

model ScheduledTransaction {
  id             String               @id @default(cuid())
  user           User                 @relation(fields: [userId], references: [id])
  userId         String
  userBucket     UserBucket           @relation(fields: [userBucketId], references: [id])
  userBucketId   String
  name           String
  amount         Decimal
  currency       String
  merchant       String?
  category       Category?            @relation(fields: [categoryId], references: [id])
  categoryId     String?
  recurrence     ScheduledRecurrence
  startDate      DateTime
  nextRunDate    DateTime
  endDate        DateTime?
  active         Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([nextRunDate])
  @@index([active])
  @@index([userId])
  @@index([userBucketId])
}

model TransactionDraft {
  id             String      @id @default(cuid())
  user           User        @relation(fields: [userId], references: [id])
  userId         String
  userBucket     UserBucket  @relation(fields: [userBucketId], references: [id])
  userBucketId   String
  date           DateTime
  amount         String
  currency       String
  merchant       String?
  category       Category?   @relation(fields: [categoryId], references: [id])
  categoryId     String?
  emailMessageId String?
  rawPayload     Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([userBucketId])
  @@index([userId])
  @@unique([userId, emailMessageId])
}

model Category {
  id                    String                @id @default(cuid())
  user                  User                  @relation(fields: [userId], references: [id])
  userId                String
  userBucket            UserBucket            @relation(fields: [userBucketId], references: [id])
  userBucketId          String
  name                  String
  idealMonthlyAmount    Decimal               @default(0)
  transactions          Transaction[]
  rules                 Rule[]
  scheduledTransactions ScheduledTransaction[]
  drafts                TransactionDraft[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@unique([userId, name])
  @@index([userId])
  @@index([userBucketId])
}

model Budget {
  id        String        @id @default(cuid())
  user      User          @relation(fields: [userId], references: [id])
  userId    String
  month     String
  income    Decimal
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  buckets   BudgetBucket[]

  @@unique([userId, month])
  @@index([userId])
}

model BudgetBucket {
  id           String      @id @default(cuid())
  budget       Budget      @relation(fields: [budgetId], references: [id])
  budgetId     String
  userBucket   UserBucket  @relation(fields: [userBucketId], references: [id])
  userBucketId String
  targetAmount Decimal
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([budgetId, userBucketId])
  @@index([userBucketId])
}

model Rule {
  id           String      @id @default(cuid())
  user         User        @relation(fields: [userId], references: [id])
  userId       String
  userBucket   UserBucket  @relation(fields: [userBucketId], references: [id])
  userBucketId String
  pattern      String
  priority     Int         @default(0)
  category     Category    @relation(fields: [categoryId], references: [id])
  categoryId   String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([categoryId])
  @@index([userId])
  @@index([userBucketId])
}

model Income {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  month     String
  name      String
  amount    Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([month])
  @@index([userId])
}

model GmailCredential {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String   @unique
  refreshToken String
  labelFilter  String?
  historyId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model NetWorthSnapshot {
  id        String           @id @default(cuid())
  user      User             @relation(fields: [userId], references: [id])
  userId    String
  month     String
  currency  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  items     NetWorthItem[]

  @@unique([userId, month])
  @@index([userId])
}

model NetWorthItem {
  id         String           @id @default(cuid())
  snapshot   NetWorthSnapshot @relation(fields: [snapshotId], references: [id])
  snapshotId String
  category   NetWorthCategory
  name       String
  amount     Decimal
  entity     String?
  note       String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([snapshotId])
}
